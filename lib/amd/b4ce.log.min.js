// B4ce.Log, v0.0.1
// Copyright (c)2012 Stefan Bunse, B4ce development
// Distributed under MIT license
// http://github.com/b4cedev/b4ce.log
(function(a,b){if(typeof exports=="object"){var c=require("underscore");module.exports=b(c)}else typeof define=="function"&&define.amd&&define(["underscore"],b)})(this,function(a){return B4ce.Log=function(a){function b(a){return a.charAt(0).toUpperCase()+a.slice(1)}function c(b,c){return b==="common"?function(){var d=Array.prototype.slice.call(arguments,arguments);return a.isArray(d[0])||a.isNumber(d[0])?b=d.shift():b=[b],this.logMessage(b,c,d)}:function(){var a=Array.prototype.slice.call(arguments,arguments);return this.logMessage([b],c,a)}}var d=function(e){var f,g,h,i,j,k={},l;e=e?a.clone(e):{},this.levels={emerg:8,alert:7,crit:6,err:5,warning:4,notice:3,info:2,debug:1},this.defaultLevel=e.defaultLevel?this.sanitizeLevel(e.defaultLevel):"debug",this.categoryLevel={},this.categories={common:1};if(e.categories){g=1;for(f in e.categories)e.categories.hasOwnProperty(f)&&(this.categories[f]||(g=g*2,this.categories[f]=g),this.categoryLevel[f]=e.categories[f]?this.sanitizeLevel(e.categories[f]):undefined)}for(f in this.categories)this.categories.hasOwnProperty(f)&&(this.categoryLevel[f]||(this.categoryLevel[f]=this.defaultLevel));e.channels||(e.channels={console:!0,alert:!0});for(f in e.channels)if(e.channels.hasOwnProperty(f)){g=e.channels[f];if(g instanceof d.Channel)k[f]=g;else{if(!this.channels[f])throw"Tried to configure invalid default channel: "+f;if(g!==!1){l={log:this};if(a.isObject(g))g.level&&(l.level=this.sanitizeLevel(g.level)),g.categories&&(l.categories=this.sanitizeCategories(g.categories));else if(g!==!0)throw'Invalid config for channel "'+f+'": '+g;k[f]=new this.channels[f](l)}}}this.channels=k;for(h in this.categories)if(this.categories.hasOwnProperty(h))for(i in this.levels)this.levels.hasOwnProperty(i)&&(h==="common"?j=i:j=h+b(i),this[j]!==undefined?this.logMessage(this.categories.common,this.levels.info,'Cannot create log method "'+j+'"'):this[j]=c(h,i))};return a.extend(d.prototype,{channels:{},logMessage:function(a,b,c){var d=[],e,f,g,h,i,j;a=this.sanitizeCategories(a),b=this.sanitizeLevel(b);for(f=0,g=a.length;f<g;f=f+1)e=a[f],this.levels[b]>=this.levels[this.categoryLevel[e]]&&d.push(e);if(!d.length)return this;for(e in this.channels)this.channels.hasOwnProperty(e)&&(h=this.channels[e],i=!0,j=d,h.filter(d,b,c)&&h.write(d,b,c));return this},sanitizeCategories:function(b){var c=[],d,e,f;if(a.isArray(b)){for(e=0,f=b.length;e<f;e=e+1)if(!this.categories.hasOwnProperty(b[e]))throw"Invalid category: "+b[e];c=b.slice()}else{if(!a.isNumber(b))throw"Invalid categories argument: "+b;for(d in this.categories)this.categories.hasOwnProperty(d)&&this.categories[d]&b&&(c.push(d),b=b-this.categories[d]);if(b>0)throw"Invalid numeric category value: "+b}return c},sanitizeLevel:function(b){var c;if(a.isString(b)){if(!this.levels.hasOwnProperty(b))throw"Invalid level: "+b;return b}if(a.isNumber(b)){for(c in this.levels)if(this.levels.hasOwnProperty(c)&&b===this.levels[c])return c;throw"Invalid numeric level: "+b}throw"Invalid level: "+b}}),d.Channel=function(b){a.extend(this,b)},a.extend(d.Channel.prototype,{filter:function(b,c,d){return this.level&&this.log.levels[c]<this.log.levels[this.level]?!1:!this.categories||!!a.intersect(this.categories,b).length},prefix:function(b,c,d){var e=c.toUpperCase();return b=a.without(b,"common"),b.length&&(e+=" ["+b.join(",")+"]"),e+=":",e},format:function(a,b,c){return this.prefix(a,b,c)+" "+c.join(" ")},write:function(a,b,c){throw"Log.Channel.write has to be overriden by actual channel implementation!"}}),d.AlertChannel=function(b){b=a.extend({level:"alert"},b),d.Channel.call(this,b)},a.extend(d.AlertChannel.prototype,d.Channel.prototype,{filter:function(a,b,c){return window.alert===undefined?!1:d.Channel.prototype.filter.call(this,a,b,c)},write:function(a,b,c){window.alert(this.format(a,b,c))}}),d.prototype.channels.alert=d.AlertChannel,d.ConsoleChannel=function(a){d.Channel.call(this,a)},a.extend(d.ConsoleChannel.prototype,d.Channel.prototype,{filter:function(a,b,c){return window.console===undefined?!1:d.Channel.prototype.filter.call(this,a,b,c)},format:function(a,b,c){return[this.prefix(a,b,c)].concat(c)},write:function(a,b,c){return window.console.log.apply(window.console,this.format(a,b,c)),this}}),d.prototype.channels.console=d.ConsoleChannel,d}(a),B4ce.Log});