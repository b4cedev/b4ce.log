/**
 * B4ce.Log - v0.0.3 - 2013-06-03
 * https://github.com/b4cedev/b4ce.log
 * Copyright (c) 2013 Stefan Bunse <s@b4ce.de>; Licensed MIT
 */
!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["jquery","underscore"],b):(a.B4ce||(a.B4ce={}),a.B4ce.Log=b(a.jQuery,a._,a.B4ce))}(this,function(a,b,c){"use strict";return c||(c={}),c.Log||(c.Log={}),function(a,c){var d={capitalize:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},createMethod:function(a,c){var d=a;return"common"===a?function(){var e=Array.prototype.slice.call(arguments,arguments);return d=b.isArray(e[0])||b.isNumber(e[0])?e.shift():[a],this.logMessage(d,c,e)}:function(){var a=Array.prototype.slice.call(arguments,arguments);return this.logMessage([d],c,a)}},extend:function(a,c){var d,e=this;d=a&&b.has(a,"constructor")?a.constructor:function(){return e.apply(this,arguments)},b.extend(d,e,c);var f=function(){this.constructor=d};return f.prototype=e.prototype,d.prototype=new f,a&&b.extend(d.prototype,a),d.__super__=e.prototype,d},sanitizeBrowser:function(){Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c,d;if(null===this)throw new TypeError("this is null or not defined");var e=Object(this),f=e.length>>>0;if("[object Function]"!=={}.toString.call(a))throw new TypeError(a+" is not a function");for(b&&(c=b),d=0;f>d;){var g;d in e&&(g=e[d],a.call(c,g,d,e)),d++}}),Function.prototype.bind&&Array.prototype.forEach&&"object"==typeof console&&"object"==typeof console.log&&["log","info","warn","error","assert","dir","clear","profile","profileEnd"].forEach(function(a){console[a]&&(console[a]=this.bind(console[a],console))},Function.prototype.call)}};c.Log.Util=d}(this,c),function(a,c){var d=function(a){a||(a={}),a.level&&(this.level=a.level),a.timestampFormatter&&(this.timestampFormatter=a.timestampFormatter),a.log&&this.setLog(a.log)};d.extend=c.Log.Util.extend,b.extend(d.prototype,{log:void 0,level:null,timestampFormatter:"default",setLog:function(a){this.log=a,this.setTimestampFormatter()},filter:function(a,c){return this.level&&this.log.levels[c]<this.log.levels[this.level]?!1:!(this.categories&&!b.intersect(this.categories,a).length)},timestamp:function(){return this._stampFormatter(new Date)},setTimestampFormatter:function(a){a&&(this.timestampFormatter=a),this.log&&(this._stampFormatter=this.log.getTimestampFormatter(this.timestampFormatter))},prefix:function(a,c,d){var e,f=[];return(e=this.timestamp(a,c,d))&&f.push(e),f.push(c.toUpperCase()),e=b.without(a,"common"),e.length&&f.push("["+e.join(",")+"]"),f.join(" ")+":"},format:function(a,b,c){return this.prefix(a,b,c)+" "+c.join(" ")},write:function(){throw"Channel.write has to be overriden by actual channel implementation!"}}),c.Log.Channel=d}(this,c),function(a,c){c.Log.Channel.Alert=c.Log.Channel.extend({constructor:function(a){a=b.extend({level:"alert"},a),c.Log.Channel.call(this,a)},filter:function(a,b,d){return void 0===window.alert?!1:c.Log.Channel.prototype.filter.call(this,a,b,d)},timestamp:function(){return null},write:function(a,b,c){window.alert(this.format(a,b,c))}})}(this,c),function(a,b){b.Log.Channel.Console=b.Log.Channel.extend({filter:function(a,c,d){return"object"!=typeof console||"function"!=typeof console.log?!1:b.Log.Channel.prototype.filter.call(this,a,c,d)},format:function(a,b,c){return[this.prefix(a,b,c)].concat(c)},write:function(a,b,c){var d,e=this.log.levels[b];return d=e>=this.log.levels.err?console.error:e>=this.log.levels.warning?console.warn:console.log,d.apply(console,this.format(a,b,c)),this}})}(this,c),function(b,c){var d=a('<div class="log-entry"></div>');c.Log.Channel.HTML=c.Log.Channel.extend({constructor:function(b){if(!b.selector)throw new Error('Required option "selector" missing!');this.selector=b.selector,this.$el=a(b.selector),c.Log.Channel.call(this,b)},filter:function(a,b,d){return this.$el?c.Log.Channel.prototype.filter.call(this,a,b,d):!1},write:function(a,b,c){return this.$el.append(d.clone().addClass([b].concat(a).join(" ")).text(this.format(a,b,c))),this}})}(this,c),function(a,c){c.Log.Util.sanitizeBrowser();var d=["debug","info","notice","warning","err","crit","alert","emerg"],e=0,f={};b.each(d,function(a){f[a]=++e});var g={alert:c.Log.Channel.Alert,console:c.Log.Channel.Console},h=Object.prototype.hasOwnProperty,i=function(a){if(b.isUndefined(a))a={};else if(!b.isObject(a))throw new Error("invalid options: "+JSON.stringify(a));a.autoLoad&&(this.autoLoad=!!a.autoLoad),a.defaultLevel&&(this.defaultLevel=this.sanitizeLevel(a.defaultLevel)),this.categories={common:1},this.categoryLevel={common:null},this.categoryValMax=this.categories.common,this.createCategoryMethods(),a.categories&&this.addCategories(a.categories),this.channels={},b.isUndefined(a.channels)?this.addChannels(g):this.addChannels(a.channels),this.autoLoad&&this.loadSettings()};b.each(f,function(a,b){i[b.toUpperCase()]=a}),b.extend(i.prototype,{persistencePrefix:"b4ce.log",autoLoad:!1,levels:f,defaultLevel:"debug",defaultTimeStampFormatter:"short",timeStampFormatters:{iso:"formatTimestampISO","short":"formatTimestampShort",utcshort:"formatTimestampUTCShort"},addCategory:function(a,b){return this.categories[a]||(this.categoryValMax*=2,this.categories[a]=this.categoryValMax),this.categoryLevel[a]=this.sanitizeLevel(b),this.createCategoryMethods(a),this},addCategories:function(a){var c=this;if(b.isObject(a))b.each(a,function(a,b){c.addCategory(b,a)});else{if(!b.isArray(a))throw new Error("categories is neither object nor array!");b.each(a,function(a){c.addCategory(a)})}return this},addChannel:function(a,d){if(this.channels[a])throw new Error("Channel name already registered: "+a);if(d instanceof c.Log.Channel)d.setLog(this),this.channels[a]=d;else if(b.isFunction(d))this.channels[a]=new d({log:this});else if(b.isFunction(g[a])){if(d===!1)return this;var e={log:this};b.isObject(d)&&b.extend(e,d),this.channels[a]=new g[a](e)}return this},addChannels:function(a){var c=this;if(!b.isObject(a))throw new Error("channels is neither object nor array!");return b.each(a,function(a,b){c.addChannel(b,a)}),this},removeChannel:function(a){if(!this.channels[a])throw new Error("Cannot remove non-existent channel: "+JSON.stringify(a));return delete this.channels[a],this},getLevel:function(a){if(b.isUndefined(a))return this.defaultLevel;var c=this.categoryLevel[a];if(b.isUndefined(c))throw new Error("Invalid category: "+JSON.stringify(a));return c},setLevel:function(a,b){var c;if(a=this.sanitizeLevel(a),void 0===b)if(a)this.defaultLevel=a;else for(c in this.categoryLevel)this.categoryLevel.hasOwnProperty(c)&&(this.categoryLevel[c]=null);else{if(!this.categoryLevel.hasOwnProperty(b))throw"Invalid category: "+b;this.categoryLevel[b]=a}return this},getSettings:function(){return{defaultLevel:this.defaultLevel,categoryLevel:b.clone(this.categoryLevel)}},setSettings:function(a){if(!b.isObject(a))throw new Error('Param "settings" is not an object!');if(h.call(a,"defaultLevel"))try{this.setLevel(a.defaultLevel)}catch(c){console.log("Error setting default level: "+c)}var d=a.categoryLevel;if(b.isObject(d)){var e=this;b.each(b.keys(this.categories),function(a){if(h.call(d,a))try{e.setLevel(d[a],a)}catch(b){console.log('Error setting level for category "'+a+'" to '+JSON.stringify(d[a])+":",b)}})}return this},loadSettings:function(){if("undefined"==typeof localStorage)return this.warning("Log.loadSettings(): No localStorage to load from!"),this;var a=localStorage.getItem(this.persistencePrefix+".settings");if(null!==a)try{a=JSON.parse(a),this.info("Log.loadSettings(): Applying saved settings"),this.setSettings(a)}catch(b){this.warning("Log.loadSettings(): Error applying saved settings:",b),this.deleteSettings()}return this},saveSettings:function(){return"undefined"==typeof localStorage?(this.warning("Log.saveSettings(): No localStorage to save to"),this):(localStorage.setItem(this.persistencePrefix+".settings",JSON.stringify(this.getSettings())),this)},deleteSettings:function(){return"undefined"==typeof localStorage?(console.warn("Log.deleteSettings(): No localStorage to delete from!"),this):(this.warning("Log.deleteSettings(): Deleting saved settings"),localStorage.removeItem(this.persistencePrefix+".settings"),this)},getFormattedTimestamp:function(a,c){b.isUndefined(a),b.isUndefined(c)&&(c=new Date)},getTimestampFormatter:function(a){a&&"default"!==a||(a=this.defaultTimeStampFormatter);var c=this.timeStampFormatters[a];if(!c)throw new Error("Invalid timestamp formatter name: "+a);if(b.isString(c)){if(!b.isFunction(this[c]))throw new Error("Invalid timestamp formatter method: "+c);c=this.timeStampFormatters[a]=this[c]}return c},formatTimestampISO:function(a){return a.toISOString()},formatTimestampShort:function(a){return b.map(["getHours","getMinutes","getSeconds"],function(b){var c=a[b]();return 10>c&&"0"+c||c}).join(":")},formatTimestampUTCShort:function(a){return a.getUTCHours()+":"+a.getUTCMinutes()+":"+a.getUTCSeconds()},createCategoryMethods:function(a){var d;if(b.isUndefined(a))d=b.keys(this.categories);else{if(!this.categories[a])throw new Error("invalid category: "+JSON.stringify(a));d=[a]}var e=this;return b.each(d,function(a){b.each(f,function(b,d){var f;f="common"===a?d:a+c.Log.Util.capitalize(d),void 0!==e[f]?e.logMessage(e.categories.common,e.levelMap.info,'Cannot create log method "'+f+'"'):e[f]=c.Log.Util.createMethod(a,d)})}),this},sanitizeCategories:function(a){var c,d,e,f=[];if(b.isArray(a)){for(d=0,e=a.length;e>d;d+=1)if(!this.categories.hasOwnProperty(a[d]))throw"Invalid category: "+a[d];f=a.slice()}else{if(!b.isNumber(a))throw"Invalid categories argument: "+a;for(c in this.categories)this.categories.hasOwnProperty(c)&&this.categories[c]&a&&(f.push(c),a-=this.categories[c]);if(a>0)throw"Invalid numeric category value: "+a}return f},sanitizeLevel:function(a){if(!a)return null;if(b.isString(a)){if(!this.levels.hasOwnProperty(a))throw"Invalid string level: "+a;return a}if(b.isNumber(a)){var c;for(c in this.levels)if(this.levels.hasOwnProperty(c)&&a===this.levels[c])return c;throw"Invalid numeric level: "+a}throw"Invalid level: "+a},logMessage:function(a,b,c){var d,e,f,g,h,i,j=[];for(a=this.sanitizeCategories(a),b=this.sanitizeLevel(b),e=0,f=a.length;f>e;e+=1)d=a[e],this.levels[b]>=this.levels[this.categoryLevel[d]||this.defaultLevel]&&j.push(d);if(!j.length)return this;for(d in this.channels)this.channels.hasOwnProperty(d)&&(g=this.channels[d],h=!0,i=j,g.filter(j,b,c)&&g.write(j,b,c));return this}}),c.Log=b.extend(i,c.Log)}(this,c),c.Log});