// B4ce.Log, v0.0.1
// Copyright (c)2012 Stefan Bunse, B4ce development
// Distributed under MIT license
// http://github.com/b4cedev/b4ce.log
B4ce=B4ce||{},B4ce.Log=function(a,b){function c(a){return a.charAt(0).toUpperCase()+a.slice(1)}function d(a,c){return a==="common"?function(){var d=Array.prototype.slice.call(arguments,arguments);return b.isArray(d[0])||b.isNumber(d[0])?a=d.shift():a=[a],this.logMessage(a,c,d)}:function(){var b=Array.prototype.slice.call(arguments,arguments);return this.logMessage([a],c,b)}}var e=function(a){var f,g,h,i,j,k={},l;a=a?b.clone(a):{},this.levels={emerg:8,alert:7,crit:6,err:5,warning:4,notice:3,info:2,debug:1},this.defaultLevel=a.defaultLevel?this.sanitizeLevel(a.defaultLevel):"debug",this.categoryLevel={},this.categories={common:1};if(a.categories){g=1;for(f in a.categories)a.categories.hasOwnProperty(f)&&(this.categories[f]||(g=g*2,this.categories[f]=g),this.categoryLevel[f]=a.categories[f]?this.sanitizeLevel(a.categories[f]):undefined)}for(f in this.categories)this.categories.hasOwnProperty(f)&&(this.categoryLevel[f]||(this.categoryLevel[f]=this.defaultLevel));a.channels||(a.channels={console:!0,alert:!0});for(f in a.channels)if(a.channels.hasOwnProperty(f)){g=a.channels[f];if(g instanceof e.Channel)k[f]=g;else{if(!this.channels[f])throw"Tried to configure invalid default channel: "+f;if(g!==!1){l={log:this};if(b.isObject(g))g.level&&(l.level=this.sanitizeLevel(g.level)),g.categories&&(l.categories=this.sanitizeCategories(g.categories));else if(g!==!0)throw'Invalid config for channel "'+f+'": '+g;k[f]=new this.channels[f](l)}}}this.channels=k;for(h in this.categories)if(this.categories.hasOwnProperty(h))for(i in this.levels)this.levels.hasOwnProperty(i)&&(h==="common"?j=i:j=h+c(i),this[j]!==undefined?this.logMessage(this.categories.common,this.levels.info,'Cannot create log method "'+j+'"'):this[j]=d(h,i))};return b.extend(e.prototype,{channels:{},logMessage:function(a,b,c){var d=[],e,f,g,h,i,j;a=this.sanitizeCategories(a),b=this.sanitizeLevel(b);for(f=0,g=a.length;f<g;f=f+1)e=a[f],this.levels[b]>=this.levels[this.categoryLevel[e]]&&d.push(e);if(!d.length)return this;for(e in this.channels)this.channels.hasOwnProperty(e)&&(h=this.channels[e],i=!0,j=d,h.filter(d,b,c)&&h.write(d,b,c));return this},sanitizeCategories:function(a){var c=[],d,e,f;if(b.isArray(a)){for(e=0,f=a.length;e<f;e=e+1)if(!this.categories.hasOwnProperty(a[e]))throw"Invalid category: "+a[e];c=a.slice()}else{if(!b.isNumber(a))throw"Invalid categories argument: "+a;for(d in this.categories)this.categories.hasOwnProperty(d)&&this.categories[d]&a&&(c.push(d),a=a-this.categories[d]);if(a>0)throw"Invalid numeric category value: "+a}return c},sanitizeLevel:function(a){var c;if(b.isString(a)){if(!this.levels.hasOwnProperty(a))throw"Invalid level: "+a;return a}if(b.isNumber(a)){for(c in this.levels)if(this.levels.hasOwnProperty(c)&&a===this.levels[c])return c;throw"Invalid numeric level: "+a}throw"Invalid level: "+a}}),e.Channel=function(a){b.extend(this,a)},b.extend(e.Channel.prototype,{filter:function(a,c,d){return this.level&&this.log.levels[c]<this.log.levels[this.level]?!1:!this.categories||!!b.intersect(this.categories,a).length},prefix:function(a,c,d){var e=c.toUpperCase();return a=b.without(a,"common"),a.length&&(e+=" ["+a.join(",")+"]"),e+=":",e},format:function(a,b,c){return this.prefix(a,b,c)+" "+c.join(" ")},write:function(a,b,c){throw"Log.Channel.write has to be overriden by actual channel implementation!"}}),e.AlertChannel=function(a){a=b.extend({level:"alert"},a),e.Channel.call(this,a)},b.extend(e.AlertChannel.prototype,e.Channel.prototype,{filter:function(a,b,c){return window.alert===undefined?!1:e.Channel.prototype.filter.call(this,a,b,c)},write:function(a,b,c){window.alert(this.format(a,b,c))}}),e.prototype.channels.alert=e.AlertChannel,e.ConsoleChannel=function(a){e.Channel.call(this,a)},b.extend(e.ConsoleChannel.prototype,e.Channel.prototype,{filter:function(a,b,c){return window.console===undefined?!1:e.Channel.prototype.filter.call(this,a,b,c)},format:function(a,b,c){return[this.prefix(a,b,c)].concat(c)},write:function(a,b,c){return window.console.log.apply(window.console,this.format(a,b,c)),this}}),e.prototype.channels.console=e.ConsoleChannel,a.Log=e,e}(B4ce,_);